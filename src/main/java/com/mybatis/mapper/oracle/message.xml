<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team2.mbti.message.model.MessageDao">
	<insert id="insertSendDmToAdmin" parameterType="sendDmVo">
		<selectKey keyProperty="sendDmNo" order="BEFORE" resultType="int">
			select send_dm_seq.nextval from dual
		</selectKey>
		insert into send_dm(send_dm_no, admin_no, send_body, receive_no)
		values(#{sendDmNo},#{adminNo},#{sendBody},#{receiveNo})
	</insert>
	
	<insert id="insertReceiveDm" parameterType="receiveDmVo">
		<selectKey keyProperty="receiveDmNo" order="BEFORE" resultType="int">
			select RECEIVE_DM_SEQ.nextval from dual
		</selectKey>
		insert into receive_dm(receive_dm_no, send_dm_no)
		values(#{receiveDmNo}, #{sendDmNo})
	</insert>
	
	<insert id="insertSendDmToMember" parameterType="sendDmVo">
		<selectKey keyProperty="sendDmNo" order="BEFORE" resultType="int">
			select send_dm_seq.nextval from dual
		</selectKey>
		insert into send_dm(send_dm_no, no, send_body, receive_no)
		values(#{sendDmNo},#{no},#{sendBody},#{receiveNo})
	</insert>

	<select id="selectAllMemberbyDm" resultType="memberVo">
		select * from member where outdate is null
		order by no desc
	</select>
	
	<select id="messageViewByNo" parameterType="sendDmVo" resultType="map">
		select sd.* , rd.read_date, rd.receive_dm_no,
			<if test="receiveManagerFlag==N"> 
				m.userid as receive_id
			</if>
			<if test="receiveManagerFlag==Y">
				ad.admin_id as receive_id
			</if>	
		from send_dm sd left join receive_dm rd
		on sd.send_dm_no = rd.send_dm_no
		<if test="receiveManagerFlag==N">
			join member m
			on sd.receive_no = m.no;
		</if>
		<if test="receiveManagerFlag==Y">
			join admin ad
			on sd.receive_no = ad.admin_no
		</if>
	</select>
	
</mapper>