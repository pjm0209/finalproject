create table board
(
	no		        number		primary key,	--ÔøΩÔøΩ»£
	name		varchar2(20)	not null,			--ÔøΩÃ∏ÔøΩ	
	pwd			varchar2(20)    not null,            --ÔøΩÔøΩ–πÔøΩ»?
	title			varchar2(100)	 not null,			--ÔøΩÔøΩÔøΩÔøΩ
	email		varchar2(80)    null,            --ÔøΩÃ∏ÔøΩÔøΩÔøΩ
	regdate 		date			default  sysdate,	--ÔøΩ€ºÔøΩÔøΩÔøΩ
	--regip		varchar2(15)	 null,			--ÔøΩ€ºÔøΩIP
	readcount	number		default 0	 null,		--ÔøΩÔøΩ»∏ÔøΩÔøΩ
	content		clob			null			--ÔøΩÔøΩÔøΩÔøΩ
);

create sequence board_seq
increment by 1
start with 1
nocache;

select * from board;

create or replace view boardview
as
select b.*, A.admin_Id, m.name, m.userId, bf.board_form_Name, bf.board_form_intro, bf.board_file_add_flag, bf.comment_flag, bf.board_flag, Z.fileCount, Z.commentCount
from (
    select b.board_no, count(c.comments_no) as commentCount, count(Y.fileCount) as fileCount
    from (    
        select b.board_no, count(f.file_name) as fileCount
        from board b join board_file f
        on b.board_no = f.board_no
        group by b.board_no
    ) Y
    right join board b
    on Y.board_no = b.board_no
    left join comments c
    on c.board_no = b.board_no
    group by b.board_no
) Z
right join board b
on Z.board_no = b.board_no
join board_form bf
on b.board_form_no = bf.board_form_no
LEFT join member m
on b.no = m.no
left join admin a
on b.admin_no = a.admin_no
order by b.board_no;

create procedure DELETEBOARD  --?ÑÎ°ú?úÏ? ?¥Î¶Ñ 
(
--Îß§Í∞úÎ≥Ä??
    m_no number,
    m_step number,
    m_groupno number
)
is
--Î≥Ä?òÏÑ†?∏Î?
    cnt number;
begin
--Ï≤òÎ¶¨???¥Ïö©
    if m_step = 0 then
        --?µÎ?Í∏Ä??Ï°¥Ïû¨?òÎäîÏßÄ Ï≤¥ÌÅ¨
        select count(*) into cnt from board
        where board_group_No = m_groupno;

        --?µÎ?Í∏Ä??Ï°¥Ïû¨?òÎäî Í≤ΩÏö∞
        if cnt > 1 then
            update board set board_Del_Flag = 'Y'
            where board_no = m_no;
        else --?µÎ?Í∏Ä???ÜÎäî Í≤ΩÏö∞
            delete board where board_no = m_no;
        end if;
    else --?µÎ?Í∏Ä ?êÏ≤¥??Í≤ΩÏö∞
        delete board where board_no = m_no;
    end if;

    commit;

EXCEPTION
    WHEN OTHERS THEN
	raise_application_error(-20001, ' ?§Ìå®!');
        ROLLBACK;
end;

create procedure DELETECOMMENTS  --?ÑÎ°ú?úÏ? ?¥Î¶Ñ 
(
--Îß§Í∞úÎ≥Ä??
    m_no number,
    m_step number,
    m_groupno number
)
is
--Î≥Ä?òÏÑ†?∏Î?
    cnt number;
begin
--Ï≤òÎ¶¨???¥Ïö©
    if m_step = 0 then
        --?µÎ?Í∏Ä??Ï°¥Ïû¨?òÎäîÏßÄ Ï≤¥ÌÅ¨
        select count(*) into cnt from comments
        where comments_group_No = m_groupno;

        --?µÎ?Í∏Ä??Ï°¥Ïû¨?òÎäî Í≤ΩÏö∞
        if cnt > 1 then
            update comments set comments_Del_Flag = 'Y'
            where comments_no = m_no;
        else --?µÎ?Í∏Ä???ÜÎäî Í≤ΩÏö∞
            delete comments where comments_no = m_no;
        end if;
    else --?µÎ?Í∏Ä ?êÏ≤¥??Í≤ΩÏö∞
        delete comments where comments_no = m_no;
    end if;

    commit;

EXCEPTION
    WHEN OTHERS THEN
	raise_application_error(-20001, ' ?§Ìå®!');
        ROLLBACK;
end;

create or replace view boardFormview
as
select bf.*, a.boardCount
from (
    select bf.board_Form_no, count(b.board_no) as boardCount
    from board_Form bf right join board b
    on bf.board_Form_no = b.board_Form_no
    group by bf.board_Form_no
) a
right join board_form bf
on bf.board_Form_no = a.board_form_no
order by bf.board_Form_NO;